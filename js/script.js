/*! squaremaths 2016-05-02 */
function changeState(a){stateFunctions[state].leave(),state=a,stateFunctions[state].enter()}function setupMatrix(a){container.innerHTML="",container.appendChild(Matrix.tabulate(a)),matrices=document.getElementsByClassName("matrices")[0],matrices.style.transform="scale("+scales+")"}function gotoNeutral(){container.style.transform="translateX(-50%) translateY(-50%)",matrices.style.transform="scale("+scales+")"}function goto(a,b){void 0===b&&(b=Math.floor(a/3),a%=3);var c=3.8;xpos=-50-a*size/c+size/c,ypos=-50-b*size/c+size/c,container.style.transform="translateX("+xpos+"%) translateY("+ypos+"%)",matrices.style.transform="scale("+4*scales+")"}function inp(a,b){var c;"2x2"==a?c=document.querySelectorAll(".\\32 x2 input")[b].value:"3x3"==a?c=document.querySelectorAll(".\\33 x3 input")[b].value:"text"==a&&(c=document.querySelectorAll(".text input")[b].value),save.data[selected].data||(save.data[selected].data=[]),save.data[selected].data[b]=c,Matrix.update(selected,save.data[selected])}function changeSidebar(a){sidebar.querySelector("#sidebar>:not(.hidden):not(.nohide)")&&sidebar.querySelector("#sidebar>:not(.hidden)").classList.add("hidden"),sidebar.getElementsByClassName(a)[0].classList.remove("hidden")}function selectMatrixType(a){selectMatrixTypeView(a),save.data[selected].type=a,save.data[selected].data=[],Matrix.update(selected,save.data[selected])}function selectMatrixTypeView(a){document.getElementsByClassName("input-matrix")[0].reset(),sidebar.querySelector(".input-matrix table:not(.hidden)")&&sidebar.querySelector(".input-matrix table:not(.hidden)").classList.add("hidden"),"none"!=a&&(sidebarTypes[a].checked=!0,sidebar.getElementsByClassName(a)[0].classList.remove("hidden"))}function matrixEditClick(){if("editor"==state){changeSidebar("input-matrix");var a=Array.prototype.indexOf.call(this.parentNode.parentNode.childNodes,this.parentNode),b=Array.prototype.indexOf.call(this.parentNode.childNodes,this);if(selected=3*a+b,save.data[selected].type){var c=save.data[selected].type;selectMatrixTypeView(c);var d;if("2x2"==c?d=document.querySelectorAll(".\\32 x2 input"):"3x3"==c?d=document.querySelectorAll(".\\33 x3 input"):"text"==c&&(d=document.querySelectorAll(".text input")),save.data[selected].data)for(var e=0;e<d.length;e++)save.data[selected].data[e]&&(d[e].value=save.data[selected].data[e])}else selectMatrixTypeView("none")}}function validateSequence(a){for(var b=a.split(","),c=0;c<b.length;c++){if(!b[c]||b[c]<1||b[c]>9)return!1;b[c]=b[c]-1}return b}function setProperty(a){save.props[a]=setProps[a](document.getElementById("prop-"+a).value)}function loadProperties(){for(var a in save.props)save.props[a]&&(document.getElementById("prop-"+a).value=save.props[a],setProps[a](save.props[a]))}function resize(){width=puzzle.offsetWidth,height=puzzle.offsetHeight,size=Math.min(width,height),scales=size/500,matrices.style.transform="scale("+scales+")","playing"==state&&goto(matNums[matIndex])}function manageMatNums(){if(clearMini(),"custom"==save.props.sequenceType){var a=validateSequence(save.props.sequence);a?(matNums=a.slice(),matIndex=matNums.length-1):(matNums=defaultMatNums.slice(),shuffle(matNums))}else matNums=defaultMatNums.slice(),shuffle(matNums)}function clearMini(){for(var a=0;a<minitable.length;a++)minitable[a].classList.remove("select")}function revolve(){matIndex+=1,matIndex==matNums.length&&(matIndex=0),goto(matNums[matIndex]),clearMini(),minitable[matNums[matIndex]].classList.add("select");for(var a=document.querySelectorAll(".matrix.hidden"),b=0;b<a.length;b++)a[b].classList.remove("hidden");setTimeout(function(){for(var a=document.querySelectorAll(".matrix"),b=0;b<a.length;b++)b!=matNums[matIndex]&&a[b].classList.add("hidden")},600)}function valid(a,b){regexes[b].test(String.fromCharCode(a.keyCode))||a.preventDefault()}var save,selected,rotationInterval,timerInterval,inRotation=!1,puzzle=document.getElementById("puzzle"),width=puzzle.offsetWidth,height=puzzle.offsetHeight,container=document.getElementsByClassName("container")[0],sidebar=document.getElementById("sidebar"),minitable=document.querySelectorAll(".minitable td"),size=Math.min(width,height),scales=size/500,defaultMatNums=[0,1,2,3,4,5,6,7,8],matNums=[],matIndex=0,matrices,state="mainmenu",stateFunctions={mainmenu:{enter:function(){el.show("launch"),container.classList.add("start"),puzzle.style.perspective="5000px"},leave:function(){el.hide("launch"),container.classList.remove("start"),puzzle.style.perspective="initial"}},editor:{enter:function(){el.style("menu","top","0px"),el.style("sidebar","left","0px"),puzzle.classList.add("editor"),resize(),save||(save={},save.type="3x3",save.data=[{},{},{},{},{},{},{},{},{}],save.props={delay:6e3,sequenceType:"random",sequence:[]},setupMatrix(save.data),document.getElementsByClassName("new")[0].innerHTML="Back")},leave:function(){el.style("menu","top","-50px"),el.style("sidebar","left","-30%"),puzzle.classList.remove("editor"),resize()}},ready:{enter:function(){el.show("ready"),el.hide("puzzle")},leave:function(){el.hide("ready"),el.show("puzzle")}},playing:{enter:function(){el.show("overlay");var a=document.getElementsByClassName("middleText")[0];a.innerHTML="3",manageMatNums(),matrices.style.opacity=0,timer.reset(),setTimeout(function(){a.innerHTML="2"},1e3),setTimeout(function(){a.innerHTML="1"},2e3),setTimeout(function(){a.innerHTML="",matrices.style.opacity=1,revolve(),rotationInterval=setInterval(revolve,save.props.delay),inRotation=!0,timerInterval=setInterval(timer.draw.bind(timer),30)},3e3)},leave:function(){el.hide("overlay"),inRotation&&(clearInterval(rotationInterval),clearInterval(timerInterval),gotoNeutral(),inRotation=!1),setTimeout(function(){for(var a=document.querySelectorAll(".matrix.hidden"),b=0;b<a.length;b++)a[b].classList.remove("hidden")},601)}},finish:{enter:function(){},leave:function(){}}};stateFunctions.mainmenu.enter(),setupMatrix(Matrix.random()),gotoNeutral(),document.getElementById("save").addEventListener("click",function(){a=document.getElementById("download");var b=JSON.stringify(save),c=new Blob([b],{type:"application/json"}),d=window.URL.createObjectURL(c);a.href=d,document.getElementById("filename").value?a.download=document.getElementById("filename").value+".json":a.download="Matrix.json",a.click(),window.URL.revokeObjectURL(d)}),document.getElementById("open").addEventListener("change",function(){function a(a){lines=a.target.result;var b;try{b=JSON.parse(lines)}catch(c){alert("Failed to load file - File is not of the right type.")}b&&b.type&&"3x3"==b.type?(document.getElementById("filename").value=a.target.fileName.slice(0,-5),save=b,loadProperties(),setupMatrix(save.data),changeState("ready"),Matrix.updateAll()):alert("File contains the wrong data  or not supported on this version.")}return"function"!=typeof window.FileReader?void alert("The file API isn't supported on this browser yet."):void(this.files?this.files[0]?(file=this.files[0],fr=new FileReader,fr.fileName=file.name,fr.onload=a,fr.readAsText(file)):alert("Please select a file before clicking 'Load'"):alert("This browser doesn't seem to support the `files` property of file inputs."))}),sidebarTypes={"2x2":document.getElementById("2x2"),"3x3":document.getElementById("3x3"),text:document.getElementById("text")};var setProps={delay:function(a){return a},sequenceType:function(a){return"random"==a?(el.hide("prop-sequence"),document.getElementById("prop-sequence").value="",setProperty("sequence"),document.getElementById("prop-sequence").style.background="rgba(0,0,0,.2)"):el.show("prop-sequence"),a},sequence:function(a){return validateSequence(a)?(document.getElementById("prop-sequence").style.background="rgba(0,0,0,.2)",a):(document.getElementById("prop-sequence").style.background="rgba(255,0,0,.1)","")}};window.onresize=resize;var autohide=document.getElementById("auto-hide"),mouseIdle,shown;overlay.onmousemove=function(){!shown&&inRotation&&(mouseIdle&&clearTimeout(mouseIdle),autohide.style.opacity=1),mouseIdle=setTimeout(function(){autohide.style.opacity=0},1e3)};var regexes={numbers:/[0-9]/,numbersandcommas:/[0-9]|,/},timer={svg:document.getElementById("timer-border"),angle:0,circum:565.5,draw:function(){this.angle+=30*this.circum/save.props.delay,this.angle%=this.circum,this.svg.style.strokeDashoffset=this.circum-this.angle+"px"},reset:function(){this.angle=0,this.svg.style.strokeDashoffset=this.circum+"px"}};